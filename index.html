<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام إدارة المطعم المتكامل</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1e293b;
      --light: #f1f5f9;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
    body { background: var(--dark); color: var(--light); }
    header { background: linear-gradient(180deg, #0c1446, rgba(12, 20, 70, 0.8)); padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .tab { cursor: pointer; padding: 0.75rem 1.5rem; border-radius: 8px; background: rgba(255,255,255,0.1); transition: all 0.3s ease; display: inline-flex; align-items: center; margin-right: 0.5rem; }
    .tab.active { background: var(--primary); color: white; }
    .card { background: var(--light); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); }
    .form-group { margin-bottom: 1rem; }
    .form-control { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 8px; background: var(--light); }
    .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-right: 0.5rem; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
    .table th { background: var(--primary); color: white; font-weight: 500; }
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert-info { background-color: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; color: #1e40af; }
    .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
    .badge-primary { background-color: var(--primary); color: white; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background: var(--light); margin: 10% auto; border-radius: 12px; width: 90%; max-width: 500px; padding: 2rem; }
    .chart-container { height: 300px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>نظام إدارة المطعم المتكامل (الوصفات + المبيعات + الجرد + الانحراف)</h1>
      <div class="tabs">
        <div class="tab active" data-tab="recipes">الوصفات (Sales Mix)</div>
        <div class="tab" data-tab="sales">المبيعات اليومية</div>
        <div class="tab" data-tab="monthly">التقرير الشهري</div>
        <div class="tab" data-tab="inventory">الجرد & الحركات</div>
        <div class="tab" data-tab="settings">إعدادات/استيراد</div>
      </div>
    </div>
  </header>
  <main class="container">
    <section id="recipes" class="card">
      <div class="form-group">
        <button class="btn btn-primary" id="btnAddItem"><i class="fas fa-plus mr-2"></i> إضافة صنف</button>
        <button class="btn btn-success" id="btnAddIng"><i class="fas fa-plus mr-2"></i> إضافة مكوّن</button>
        <button class="btn btn-success" id="btnSave"><i class="fas fa-save mr-2"></i> حفظ (LocalStorage)</button>
        <button class="btn" id="btnExport"><i class="fas fa-download mr-2"></i> تصدير JSON</button>
      </div>
      <div class="table-responsive">
        <table id="tblRecipes"></table>
      </div>
      <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle mr-2"></i> أدخل كميات المكونات **لكل وحدة بيع**. مثال: صنف 12PCS يستخدم 12 قطعة دجاج → في عمود CHIX اكتب 12.
      </div>
    </section>
    
    <section id="sales" class="card" style="display: none">
      <div class="form-group row">
        <div class="col-md-4">
          <label>التاريخ</label>
          <input type="date" id="saleDate" class="form-control" value="">
        </div>
        <div class="col-md-4">
          <label>الصنف</label>
          <select id="saleItem" class="form-control"></select>
        </div>
        <div class="col-md-4">
          <label>الكمية</label>
          <input type="number" id="saleQty" class="form-control" min="1" value="1">
        </div>
      </div>
      <button class="btn btn-primary" id="btnAddSale"><i class="fas fa-plus mr-2"></i> إضافة حركة بيع</button>
      <button class="btn btn-success" id="btnSaveSales"><i class="fas fa-save mr-2"></i> حفظ المبيعات</button>
      <button class="btn" id="btnExportSales"><i class="fas fa-download mr-2"></i> تصدير المبيعات CSV</button>
      <div class="table-responsive mt-3">
        <table id="tblSales"></table>
      </div>
    </section>
    
    <section id="monthly" class="card" style="display: none">
      <div class="form-group">
        <label>شهر التقرير</label>
        <input type="month" id="repMonth" class="form-control" value="">
      </div>
      <button class="btn btn-primary" id="btnBuildMonthly"><i class="fas fa-chart-bar mr-2"></i> حساب التقرير</button>
      <button class="btn" id="btnExportMonthly"><i class="fas fa-download mr-2"></i> تصدير ملخص CSV</button>
      <div class="chart-container mt-3">
        <canvas id="monthlyChart"></canvas>
      </div>
    </section>
    
    <section id="inventory" class="card" style="display: none">
      <div class="form-group">
        <button class="btn btn-success" id="btnSaveInv"><i class="fas fa-save mr-2"></i> حفظ الجرد والحركات</button>
        <button class="btn" id="btnCalcVariance"><i class="fas fa-calculator mr-2"></i> حساب الانحراف</button>
      </div>
      <div class="table-responsive mt-3">
        <table id="tblInventory"></table>
      </div>
      <div class="table-responsive mt-3">
        <table id="tblVariance"></table>
      </div>
    </section>
    
    <section id="settings" class="card" style="display: none">
      <div class="form-group">
        <input type="file" id="fileImport" accept=".json">
        <button class="btn btn-primary" id="btnImport"><i class="fas fa-upload mr-2"></i> استيراد JSON</button>
        <button class="btn btn-danger" id="btnReset"><i class="fas fa-trash-alt mr-2"></i> مسح كل البيانات</button>
      </div>
    </section>
  </main>
  
  <footer class="container py-4 text-center text-gray-600">
    <p><i class="fas fa-lightbulb mr-2"></i> نصيحة: وحِّد وحدات القياس (قطعة/جرام/لتر) داخل الحسابات. عوامل التحويل تُستخدم فقط للعرض.</p>
  </footer>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script>
    // ========= Data Model =========
    const DB_KEY = 'restaurant_management_system';
    let state = {
      ingredients: [
        'CHIX','STRIP','BEEFBURGER','Beef burger 125 g','CHIX BURGER','ZINGER','FRIES','CHEES','GARLICSUACE','SMALL CLOWSLOW','BIG CLOWSLOW','DYNAMTESAUCE','BPESI PIP','PEPSI LITER','LARGE JUICE','SMALL WATER','BUN 4 INCH','TORTILA','BUN 4.5 INCH','BUN 6 INCH','SAMOLINA 8 INCH','BUN 5','NUGGETS','SMALL JUICE','POP CORN','SHAWRMA','BASMATI RICE','KINZA COLA','FLOOR','lettuce','Mayonnaise','ketchup','SHORTING'
      ],
      items: [
        {name:'12 PCS PACKET MIX', family:'Combo Meal Mix', group:'Food', recipe: {CHIX:12, GARLICSUACE:3, 'SMALL CLOWSLOW':3, 'BUN 5':3, 'BUN 4 INCH':6}},
        {name:'16 PCS PACKET MIX', family:'Combo Meal Mix', group:'Food', recipe: {CHIX:16, FRIES:5, GARLICSUACE:4, 'BUN 5':4, 'BUN 4 INCH':8}},
        {name:'20 PCS PACKET MIX', family:'Combo Meal Mix', group:'Food', recipe: {CHIX:20, FRIES:5, GARLICSUACE:5, 'BUN 5':5, 'BUN 4 INCH':8}},
        {name:'BUCKET MEAL MIX', family:'Combo Meal Mix', group:'Food', recipe: {CHIX:8, STRIP:8, FRIES:5, 'SMALL WATER':1, 'BUN 4 INCH':8}}
      ],
      sales: [
        {date:'2025-03-01', item:'12 PCS PACKET MIX', qty:1},
        {date:'2025-03-29', item:'12 PCS PACKET MIX', qty:111}
      ],
      inventory: { }
    };
    
    // ========= Persistence =========
    function load(){
      const raw = localStorage.getItem(DB_KEY);
      if(raw){
        try{ state = JSON.parse(raw); }catch(e){ console.warn('failed parse'); }
      }
    }
    function save(){ localStorage.setItem(DB_KEY, JSON.stringify(state)); }
    
    // ========= Helpers =========
    const qs = s=>document.querySelector(s);
    const ce = (tag,props={})=>Object.assign(document.createElement(tag),props);
    function fmt(n){ return Number(n||0).toLocaleString('ar-EG'); }
    function unique(arr){ return [...new Set(arr)]; }
    
    // ========= Tabs =========
    [...document.querySelectorAll('.tab')].forEach(t=>t.addEventListener('click',()=>{
      document.querySelectorAll('main section').forEach(s=>s.style.display='none');
      qs('#'+t.dataset.tab).style.display='block';
    }));
    
    // ========= Recipes UI =========
    function drawRecipes(){
      qs('#countItems').textContent = state.items.length;
      qs('#countIngs').textContent = state.ingredients.length;
      const tbl = qs('#tblRecipes');
      tbl.innerHTML='';
      const thead = ce('thead');
      const hr = ce('tr');
      ;['#','اسم الصنف','المجموعة','الفئة','—'].concat(state.ingredients).forEach((h,i)=>{
        const th = ce('th',{textContent:h});
        if(i>=5) th.title='كمية لكل وحدة بيع';
        hr.appendChild(th);
      });
      thead.appendChild(hr); tbl.appendChild(thead);
      const tb=ce('tbody');
      state.items.forEach((it,idx)=>{
        const tr=ce('tr');
        tr.appendChild(ce('td',{textContent:idx+1}))
        const name=ce('input',{value:it.name}); name.onchange=()=>{it.name=name.value; fillSaleItems(); save();}
        const fam=ce('input',{value:it.family||''}); fam.onchange=()=>{it.family=fam.value; save();}
        const grp=ce('input',{value:it.group||''}); grp.onchange=()=>{it.group=grp.value; save();}
        const del=ce('button',{textContent:'حذف'}); del.onclick=()=>{state.items.splice(idx,1); drawRecipes(); fillSaleItems(); save();}
        const tdName=ce('td'); tdName.appendChild(name); tr.appendChild(tdName);
        const tdFam=ce('td'); tdFam.appendChild(fam); tr.appendChild(tdFam);
        const tdGrp=ce('td'); tdGrp.appendChild(grp); tr.appendChild(tdGrp);
        const tdDel=ce('td'); tdDel.appendChild(del); tr.appendChild(tdDel);
        // recipe cells
        if(!it.recipe) it.recipe={};
        state.ingredients.forEach(ing=>{
          const v=it.recipe[ing]||0;
          const inp=ce('input',{type:'number', step:'0.001', value:v});
          inp.onchange=()=>{ it.recipe[ing]=Number(inp.value)||0; save(); };
          const td=ce('td'); td.appendChild(inp); tr.appendChild(td);
        });
        tb.appendChild(tr);
      });
      tbl.appendChild(tb);
      drawChips();
    }
    qs('#btnAddItem').onclick=()=>{ state.items.push({name:'صنف جديد', family:'', group:'', recipe:{}}); drawRecipes(); fillSaleItems(); save(); }
    qs('#btnAddIng').onclick=()=>{
      const name=prompt('اسم المكوّن (حروف لاتينية/إنجليزية يفضّل بلا مسافات)');
      if(!name) return;
      if(state.ingredients.includes(name)) return alert('المكوّن موجود');
      state.ingredients.push(name);
      drawRecipes(); fillSaleItems(); drawInventory(); save();
    }
    qs('#btnSave').onclick=save;
    qs('#btnExport').onclick=()=>{
      const url = URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'}));
      const a = ce('a',{href:url, download:'restaurant-management.json'}); a.click(); URL.revokeObjectURL(url);
    }
    function drawChips(){
      const box=qs('#ingChips'); box.innerHTML='';
      state.ingredients.forEach(ing=>{
        const c=ce('div',{className:'badge badge-primary',textContent:ing}); box.appendChild(c);
      })
    }
    // ========= Sales UI =========
    function fillSaleItems(){
      const sel=qs('#saleItem'); sel.innerHTML='';
      state.items.forEach(it=> sel.appendChild(ce('option',{value:it.name,textContent:it.name})) );
    }
    function drawSales(){
      qs('#salesRows').textContent = state.sales.length;
      const tbl=qs('#tblSales'); tbl.innerHTML='';
      const thead=ce('thead');
      thead.innerHTML='<tr><th>#</th><th>التاريخ</th><th>الصنف</th><th>الكمية</th><th>—</th></tr>';
      tbl.appendChild(thead);
      const tb=ce('tbody');
      state.sales.forEach((s,i)=>{
        const tr=ce('tr');
        tr.appendChild(ce('td',{textContent:i+1}))
        const d=ce('input',{type:'date', value:s.date}); d.onchange=()=>{s.date=d.value; save();}
        const itm=ce('select'); state.items.forEach(it=> itm.appendChild(ce('option',{value:it.name,textContent:it.name, selected:it.name===s.item})) ); itm.onchange=()=>{s.item=itm.value; save();}
        const q=ce('input',{type:'number', step:'1', min:'0', value:s.qty}); q.onchange=()=>{s.qty=Number(q.value)||0; save();}
        const del=ce('button',{textContent:'حذف'}); del.onclick=()=>{state.sales.splice(i,1); drawSales(); save();}
        const td1=ce('td'); td1.appendChild(d); tr.appendChild(td1);
        const td2=ce('td'); td2.appendChild(itm); tr.appendChild(td2);
        const td3=ce('td'); td3.appendChild(q); tr.appendChild(td3);
        const td4=ce('td'); td4.appendChild(del); tr.appendChild(td4);
        tb.appendChild(tr);
      })
      tbl.appendChild(tb);
    }
    qs('#btnAddSale').onclick=()=>{
      const d=qs('#saleDate').value || new Date().toISOString().slice(0,10);
      const it=qs('#saleItem').value || (state.items[0]?.name||'');
      const q=Number(qs('#saleQty').value)||1;
      state.sales.push({date:d,item:it,qty:q}); drawSales(); save();
    }
    qs('#btnSaveSales').onclick=save;
    qs('#btnExportSales').onclick=()=>{
      const rows=[['Date','Item','Qty'].concat(state.sales.map(s=>[s.date,s.item,s.qty]))];
      const csv=rows.map(r=>r.join(',')).join('\n');
      const url = URL.createObjectURL(new Blob([csv,{type:'text/csv'}]));
      ce('a',{href:url,download:'sales.csv'}).click(); URL.revokeObjectURL(url);
    }
    // ========= Monthly UI =========
    function buildMonthly(){
      const ym = qs('#repMonth').value || new Date().toISOString().slice(0,7);
      const days = daysInMonth(ym);
      const use = usageByMonth(ym);
      const tbl=qs('#tblMonthly'); tbl.innerHTML='';
      const thead=ce('thead');
      const hr=ce('tr');
      hr.appendChild(ce('th',{textContent:'التاريخ'}));
      state.ingredients.forEach(ing=> hr.appendChild(ce('th',{textContent:ing})) );
      thead.appendChild(hr); tbl.appendChild(thead);
      const tb=ce('tbody');
      let totals={};
      days.forEach(d=>{
        const tr=ce('tr'); tr.appendChild(ce('td',{textContent:d}));
        state.ingredients.forEach(ing=>{
          const v = (use[d]?.[ing])||0;
          totals[ing]=(totals[ing]||0)+v;
          tr.appendChild(ce('td',{textContent:fmt(v)}));
        })
        tb.appendChild(tr);
      })
      tbl.appendChild(tb);
      // Store latest monthly totals for variance table to reference
      state.__lastMonthlyTotals = totals; save();
    }
    qs('#btnBuildMonthly').onclick=buildMonthly;
    function buildMonthly(){
      const ym = qs('#repMonth').value || new Date().toISOString().slice(0,7);
      const days = daysInMonth(ym);
      const use = usageByMonth(ym);
      const totals = getTotalUsage(use);
      const tbl=qs('#tblMonthly'); tbl.innerHTML='';
      const thead=ce('thead');
      thead.innerHTML='<tr><th>التاريخ</th>'+state.ingredients.map(ing=>`<th>${ing}</th>`).join('')+'</tr>';
      tbl.appendChild(thead);
      const tb=ce('tbody');
      days.forEach(d=>{
        const tr=ce('tr'); tr.appendChild(ce('td',{textContent:d}));
        state.ingredients.forEach(ing=>{
          const v = (use[d]?.[ing])||0;
          tr.appendChild(ce('td',{textContent:fmt(v)}));
        })
        tb.appendChild(tr);
      })
      tbl.appendChild(tb);
      // Store latest monthly totals for variance table to reference
      state.__lastMonthlyTotals = totals; save();
    }
    qs('#btnExportMonthly').onclick=()=>{
      const ym = qs('#repMonth').value || new Date().toISOString().slice(0,7);
      const totals = state.__lastMonthlyTotals || {};
      const rows = [['Ingredient','TotalRecipe('+ym+')']];
      state.ingredients.forEach(ing=> rows.push([ing, (totals[ing]||0)]) );
      const csv=rows.map(r=>r.join(',')).join('\n');
      const url = URL.createObjectURL(new Blob([csv,{type:'text/csv'}));
      ce('a',{href:url,download:'monthly_totals_'+ym+'.csv'}).click(); URL.revokeObjectURL(url);
    }
    function usageByMonth(ym){ // ym=YYYY-MM
      const days = daysInMonth(ym);
      const result = {}; // {date:{ing:qty}}
      days.forEach(d=>{
        result[d]=usageByDate(d);
      })
      return result;
    }
    function usageByDate(date){
      // returns {ing: qtyUsed}
      const obj={};
      state.sales.filter(s=>s.date===date).forEach(s=>{
        const rec = mapRecipe(s.item);
        Object.entries(rec).forEach(([ing,qty])=>{
          obj[ing]=(obj[ing]||0)+ (s.qty*Number(qty||0));
        })
      })
      return obj;
    }
    function daysInMonth(ym){ // ym=YYYY-MM
      const [y,m]=ym.split('-').map(Number); const last=new Date(y,m,0).getDate();
      const arr=[]; for(let d=1; d<=last; d++){ arr.push(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`) }
      return arr;
    }
    // ========= Inventory UI =========
    function ensureInv(){
      state.ingredients.forEach(ing=>{
        if(!state.inventory[ing]) state.inventory[ing]={begin:0,purchases:0,tin:0,tout:0,waste:0,end:0};
      }
    }
    function drawInventory(){
      ensureInv();
      const tbl=qs('#tblInventory'); tbl.innerHTML='';
      const thead=ce('thead');
      thead.innerHTML='<tr><th>المكوّن</th><th>رصيد أول</th><th>مشتريات</th><th>تحويلات داخلة</th><th>تحويلات خارجة</th><th>هالك</th><th>رصيد آخر</th></tr>';
      tbl.appendChild(thead);
      const tb=ce('tbody');
      state.ingredients.forEach(ing=>{
        const inv=state.inventory[ing];
        const tr=ce('tr'); tr.appendChild(ce('td',{textContent:ing}))
        ;['begin','purchases','tin','tout','waste','end'].forEach(key=>{
          const inp=ce('input',{type:'number', step:'0.001', value:inv[key]||0});
          inp.onchange=()=>{ inv[key]=Number(inp.value)||0; save(); };
          const td=ce('td'); td.appendChild(inp); tr.appendChild(td);
        })
        tb.appendChild(tr);
      })
      tbl.appendChild(tb);
    }
    qs('#btnSaveInv').onclick=save;
    qs('#btnCalcVariance').onclick=()=>{
      const totals = state.__lastMonthlyTotals || {};
      const tbl=qs('#tblVariance'); tbl.innerHTML='';
      const thead=ce('thead');
      thead.innerHTML='<tr><th>المكوّن</th><th>Total Recipe</th><th>Actual</th><th>Variance (Actual-Recipe)</th></tr>';
      tbl.appendChild(thead);
      const tb=ce('tbody');
      state.ingredients.forEach(ing=>{
        const inv=state.inventory[ing]||{};
        const actual=(+inv.begin||0)+(+inv.purchases||0)+(+inv.tin||0)-(+inv.tout||0)-(+inv.end||0)-(+inv.waste||0);
        const recipe=+totals[ing]||0;
        const varc=actual - recipe;
        const tr=ce('tr');
        tr.appendChild(ce('td',{textContent:ing}))
        tr.appendChild(ce('td',{textContent:fmt(recipe)}))
        tr.appendChild(ce('td',{textContent:fmt(actual)}))
        const tdv=ce('td',{textContent:fmt(varc)}); tdv.style.color = varc>0? 'var(--danger)': (varc<0? 'var(--ok)':'')); tr.appendChild(tdv);
        tb.appendChild(tr);
      })
      tbl.appendChild(tb);
    }
    // ========= Import/Reset =========
    qs('#btnImport').addEventListener('change',handleImport);
    qs('#btnReset').addEventListener('click',handleReset);
    function handleImport(e){
      const f=qs('#fileImport').files[0]; if(!f) return alert('اختر ملف JSON');
      const r=new FileReader(); r.onload=e=>{ try{ state=JSON.parse(e.target.result); save(); init(); }catch(err){ alert('ملف غير صالح'); } }; r.readAsText(f);
    }
    function handleReset(){
      if(confirm('مسح كل البيانات؟')){ localStorage.removeItem(DB_KEY); location.reload(); }
    // ========= Boot =========
    function init(){
      load();
      drawRecipes();
      fillSaleItems();
      qs('#repMonth').value = new Date().toISOString().slice(0,7);
      buildMonthly();
      drawInventory();
    }
    init();
  </script>
</body>
</html>
