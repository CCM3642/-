  function handleFiles(files) {
    ([...files]).forEach(uploadFile);
  }

  function uploadFile(file) {
    const fileItem = document.createElement('div');
    fileItem.classList.add('file-item');
    fileItem.innerHTML = <span class="hljs-subst">${file.name}</span> &lt;button class=&quot;remove-file&quot; data-name=&quot;<span class="hljs-subst">${file.name}</span>&quot;&gt;Remove&lt;/button&gt;;
    document.getElementById('fileList').appendChild(fileItem);

    uploadedFiles.push(file);

    const removeButton = fileItem.querySelector('.remove-file');
    removeButton.addEventListener('click', function() {
      fileItem.remove();
      uploadedFiles = uploadedFiles.filter(f => f.name !== file.name);
    });
  }
}

  // Form submission to add ticket
  function addTicket() {
    const orderId = document.getElementById('orderId').value;
    const branch = document.getElementById('branch').value;
    const platform = document.getElementById('platform').value;
    const status = document.getElementById('status').value;
    const issue = document.getElementById('issue').value;
    const evidence = document.getElementById('evidence').value;

    const newTicket = {
      id: Date.now(),
      orderId,
      branch,
      platform,
      status,
      issue,
      evidence,
      createdAt: new Date().toISOString(),
      files: uploadedFiles.map(file => file.name) // saving file names or paths
    };

    tickets.push(newTicket);
    localStorage.setItem('crispyTickets', JSON.stringify(tickets));

    renderTickets();
    updateStats();
    showNotification(<span class="hljs-subst">${newTicket.orderId}</span> added successfully!);
    document.getElementById('ticketForm').reset();
    uploadedFiles = [];
    document.getElementById('fileList').innerHTML = ''; // clear file list
  }

  // Render tickets in the table
  function renderTickets() {
    const ticketsTableBody = document.getElementById('ticketsTable').querySelector('tbody');
    ticketsTableBody.innerHTML = '';
    filteredTickets.forEach(ticket => {
      const row = document.createElement('tr');
      row.innerHTML =         &lt;td&gt;<span class="hljs-subst">${ticket.orderId}</span>&lt;/td&gt;         &lt;td&gt;<span class="hljs-subst">${ticket.branch}</span>&lt;/td&gt;         &lt;td&gt;<span class="hljs-subst">${ticket.platform}</span>&lt;/td&gt;         &lt;td&gt;<span class="hljs-subst">${ticket.issue}</span>&lt;/td&gt;         &lt;td&gt;&lt;a href=&quot;<span class="hljs-subst">${ticket.evidence}</span>&quot; target=&quot;_blank&quot;&gt;Link&lt;/a&gt;&lt;/td&gt;         &lt;td&gt;<span class="hljs-subst">${ticket.status}</span>&lt;/td&gt;         &lt;td&gt;<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(ticket.createdAt).toLocaleString()}</span>&lt;/td&gt;         &lt;td&gt;           &lt;button class=&quot;btn btn-sm btn-primary&quot; onclick=&quot;viewTicket(<span class="hljs-subst">${ticket.id}</span>)&quot;&gt;View&lt;/button&gt;           &lt;button class=&quot;btn btn-sm btn-warning&quot; onclick=&quot;editTicket(<span class="hljs-subst">${ticket.id}</span>)&quot;&gt;Edit&lt;/button&gt;           &lt;button class=&quot;btn btn-sm btn-danger&quot; onclick=&quot;deleteTicket(<span class="hljs-subst">${ticket.id}</span>)&quot;&gt;Delete&lt;/button&gt;         &lt;/td&gt;      ;
      ticketsTableBody.appendChild(row);
    });

    updatePagination();
  }

  function viewTicket(ticketId) {
    currentTicketId = ticketId;
    const ticket = tickets.find(t => t.id === ticketId);
    document.getElementById('viewOrderId').textContent = ticket.orderId;
    document.getElementById('viewBranch').textContent = ticket.branch;
    document.getElementById('viewPlatform').textContent = ticket.platform;
    document.getElementById('viewStatus').textContent = ticket.status;
    document.getElementById('viewIssue').textContent = ticket.issue;
    document.getElementById('viewEvidence').textContent = ticket.evidence || 'None';
    document.getElementById('viewDateCreated').textContent = new Date(ticket.createdAt).toLocaleString();
    document.getElementById('viewAttachments').innerHTML = ticket.files.map(file => &lt;p&gt;<span class="hljs-subst">${file}</span>&lt;/p&gt;).join('');

    // Show/hide timeline responses based on ticket status
    // Example - You should implement based on actual data collected
    const timelineCreated = document.getElementById('timelineCreated');
    timelineCreated.textContent = new Date(ticket.createdAt).toLocaleString();
    document.getElementById('timelineSentItem').style.display = ticket.status === 'Sent' ? 'block' : 'none';
    document.getElementById('timelineClosedItem').style.display = ticket.status === 'Closed' ? 'block' : 'none';

    const viewModal = new bootstrap.Modal(document.getElementById('viewTicketModal'));
    viewModal.show();
  }

  function editTicket(ticketId) {
    const ticket = tickets.find(t => t.id === ticketId);
    document.getElementById('editTicketId').value = ticketId;
    document.getElementById('editOrderId').value = ticket.orderId;
    document.getElementById('editBranch').value = ticket.branch;
    document.getElementById('editPlatform').value = ticket.platform;
    document.getElementById('editStatus').value = ticket.status;
    document.getElementById('editIssue').value = ticket.issue;
    document.getElementById('editEvidence').value = ticket.evidence;

    const editModal = new bootstrap.Modal(document.getElementById('editTicketModal'));
    editModal.show();
  }

  function saveEditedTicket() {
    const ticketId = parseInt(document.getElementById('editTicketId').value);
    const ticketIndex = tickets.findIndex(t => t.id === ticketId);

    if (ticketIndex !== -1) {
      tickets[ticketIndex] = {
        ...tickets[ticketIndex],
        orderId: document.getElementById('editOrderId').value,
        branch: document.getElementById('editBranch').value,
        platform: document.getElementById('editPlatform').value,
        status: document.getElementById('editStatus').value,
        issue: document.getElementById('editIssue').value,
        evidence: document.getElementById('editEvidence').value
      };

      localStorage.setItem('crispyTickets', JSON.stringify(tickets));
      renderTickets();
      updateStats();
      showNotification(Ticket updated successfully!);

      const editModal = bootstrap.Modal.getInstance(document.getElementById('editTicketModal'));
      editModal.hide();
    }
  }

  function deleteTicket(ticketId) {
    const ticketIndex = tickets.findIndex(t => t.id === ticketId);
    if (ticketIndex !== -1) {
      tickets.splice(ticketIndex, 1);
      localStorage.setItem('crispyTickets', JSON.stringify(tickets));
      renderTickets();
      updateStats();
      showNotification(Ticket deleted successfully!);
    }
  }

  function updateStats() {
    document.getElementById('totalTickets').innerText = tickets.length;
    document.getElementById('openTickets').innerText = tickets.filter(t => t.status === 'Open').length;
    document.getElementById('sentTickets').innerText = tickets.filter(t => t.status === 'Sent').length;
    document.getElementById('closedTickets').innerText = tickets.filter(t => t.status === 'Closed').length;
  }

  function updatePagination() {
    const totalRecords = filteredTickets.length;
    const showingFrom = (currentPage - 1) * itemsPerPage + 1;
    const showingTo = Math.min(currentPage * itemsPerPage, totalRecords);
    document.getElementById('showingFrom').textContent = showingFrom;
    document.getElementById('showingTo').textContent = showingTo;
    document.getElementById('totalRecords').textContent = totalRecords;

    const pagination = document.getElementById('pagination');
    pagination.innerHTML = ''; // Clear existing pagination
    const totalPages = Math.ceil(totalRecords / itemsPerPage);

    for (let page = 1; page <= totalPages; page++) {
      const pageButton = document.createElement('button');
      pageButton.textContent = page;
      pageButton.className = 'btn btn-outline-secondary mx-1';
      pageButton.onclick = () => {
        currentPage = page;
        renderTickets();
      };
      pagination.appendChild(pageButton);
    }
  }

  function applyFilters() {
    const searchOrder = document.getElementById('searchOrder').value.toLowerCase();
    const filterBranch = document.getElementById('filterBranch').value;
    const filterPlatform = document.getElementById('filterPlatform').value;
    const filterStatus = document.getElementById('filterStatus').value;

    filteredTickets = tickets.filter(ticket => {
      const matchesSearch = ticket.orderId.toLowerCase().includes(searchOrder);
      const matchesBranch = !filterBranch || ticket.branch === filterBranch;
      const matchesPlatform = !filterPlatform || ticket.platform === filterPlatform;
      const matchesStatus = !filterStatus || ticket.status === filterStatus;
      return matchesSearch && matchesBranch && matchesPlatform && matchesStatus;
    });

    currentPage = 1; // reset to first page
    renderTickets();
    updateStats();
    updatePagination();
  }

  function resetFilters() {
    document.getElementById('searchOrder').value = '';
    document.getElementById('filterBranch').value = '';
    document.getElementById('filterPlatform').value = '';
    document.getElementById('filterStatus').value = '';
    applyFilters(); // Reapply filters after resetting
  }

  function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.querySelector('#notificationText').textContent = message;
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 3000);
  }

  function toggleTheme() {
    const currentTheme = document.body.getAttribute('data-theme') || 'light';
    document.body.setAttribute('data-theme', currentTheme === 'light' ? 'dark' : 'light');
  }

  // Chart initializations and data configurations
  function initCharts() {
    const ctxPlatform = document.getElementById('platformChart').getContext('2d');
    const ctxBranch = document.getElementById('branchChart').getContext('2d');

    platformChart = new Chart(ctxPlatform, {
      type: 'bar',
      data: {
        labels: ['Noon', 'Careem'],
        datasets: [{
          label: 'Tickets',
          data: [0, 0],
          backgroundColor: [var('--crispy-red'), var('--crispy-light')],
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    branchChart = new Chart(ctxBranch, {
      type: 'doughnut',
      data: {
        labels: ['Khaldia', 'Muroor', 'Shabiya11', 'AlBarsha', 'AlSatwa', 'Electra', 'Hamdan'],
        datasets: [{
          data: Array(7).fill(0), // example array for each branch
          backgroundColor: [var('--crispy-red'), var('--crispy-light'), var('--crispy-accent'), '#ffc107', '#dc3545', '#17a2b8', '#28a745'],
        }]
      },
      options: {
        responsive: true
      }
    });
  }
</script>
</body>
</html>
