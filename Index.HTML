<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crispy Chicken UAE - نظام إدارة</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121a33;
      --muted: #8aa0c6;
      --text: #eaf1ff;
      --accent: #4dd0e1;
      --accent2: #ffd166;
      --danger: #ff6b6b;
      --ok: #5ad37d;
      --primary: #b22222;
      --hover: #d32f2f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Cairo", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, #0b1020, rgba(11,16,32,.6));
      backdrop-filter: blur(8px);
      z-index: 50;
      border-bottom: 1px solid #1f2b50;
      padding: 10px;
      text-align: center;
    }
    header img {
      max-width: 100px;
      vertical-align: middle;
    }
    header h1 {
      display: inline-block;
      margin: 0 10px;
      font-size: 24px;
      color: var(--accent2);
      vertical-align: middle;
    }
    .wrap { max-width: 1200px; margin: auto; padding: 12px; }
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
      justify-content: center;
    }
    .tab {
      padding: 10px 14px;
      border: 1px solid #23315b;
      border-radius: 12px;
      background: #121a33;
      cursor: pointer;
      user-select: none;
    }
    .tab.active {
      background: linear-gradient(90deg, #1a2450, #18264a);
      border-color: #345;
      box-shadow: 0 0 0 2px #1f2b50 inset;
    }
    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 14px 0;
      align-items: center;
    }
    button {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #2a3a6f;
      background: #172247;
      color: var(--text);
      cursor: pointer;
    }
    button.primary { background: var(--primary); border-color: var(--primary); }
    button.primary:hover { background: var(--hover); }
    button.good { background: linear-gradient(90deg, #0a6b4a, #0a553e); border-color: #1b8a61; }
    button.warn { background: linear-gradient(90deg, #7a2a2a, #6a1e1e); border-color: #a74343; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .card {
      background: var(--card);
      border: 1px solid #21315d;
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 700px;
    }
    th, td {
      border-bottom: 1px solid #243466;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      position: sticky;
      top: 0;
      background: #172247;
      z-index: 2;
    }
    tbody tr:hover { background: #0f1836; }
    input, select {
      background: #0f1733;
      border: 1px solid #29407b;
      color: var(--text);
      border-radius: 8px;
      padding: 6px 8px;
    }
    .row { display: grid; gap: 10px; }
    .row.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { padding: 4px 8px; border: 1px dashed #345; border-radius: 999px; }
    .scroll-x { overflow: auto; }
    .muted { color: var(--muted); }
    .note { font-size: 12px; color: #c8d7ffb3; }
    .kpi { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .kpi .box {
      background: #111a34;
      border: 1px solid #22305a;
      border-radius: 14px;
      padding: 10px;
    }
    .box h3 { margin: 0 0 6px 0; font-size: 13px; color: var(--muted); }
    .box b { font-size: 18px; }
    .danger { color: var(--danger); }
    .ok { color: var(--ok); }
    footer { padding: 20px 0; color: #9db3e6; font-size: 12px; text-align: center; }
    .pill { padding: 2px 8px; border-radius: 999px; border: 1px solid #2a3a6f; background: #0f1733; font-size: 12px; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      z-index: 100;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }
    .search-box { margin-left: auto; }
    .search-box input { width: 200px; }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/CCM3642/Crispychickenofferauh/main/logo.png" alt="Crispy Chicken Logo">
    <h1>Crispy Chicken UAE</h1>
  </header>

  <main class="wrap">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="branches">الفروع</div>
      <div class="tab" data-tab="recipes">الوصفات</div>
      <div class="tab" data-tab="sales">المبيعات اليومية</div>
      <div class="tab" data-tab="monthly">التقرير الشهري</div>
      <div class="tab" data-tab="inventory">الجرد & الحركات</div>
      <div class="tab" data-tab="settings">إعدادات</div>
    </div>

    <section id="branches" class="card">
      <div class="toolbar">
        <button class="primary" onclick="showAddBranchModal()">➕ إضافة فرع جديد</button>
      </div>
      <ul id="branchList" style="list-style:none;padding:0;"></ul>
    </section>

    <section id="recipes" class="card" style="display:none">
      <div class="toolbar">
        <button class="primary" id="btnAddItem">+ إضافة صنف</button>
        <button id="btnAddIng">+ إضافة مكوّن</button>
        <button class="good" id="btnSave">💾 حفظ</button>
        <button id="btnExport">⬇️ تصدير JSON</button>
        <label class="pill">عدد الأصناف: <span id="countItems">0</span></label>
        <label class="pill">عدد المكونات: <span id="countIngs">0</span></label>
      </div>
      <div class="scroll-x">
        <table id="tblRecipes"></table>
      </div>
      <p class="note">أدخل كميات المكونات **لكل وحدة بيع**. مثال: صنف 12PCS يستخدم 12 قطعة دجاج → في عمود CHIX اكتب 12.</p>
    </section>

    <section id="sales" class="card" style="display:none">
      <div class="toolbar">
        <div class="row cols-3" style="width:100%">
          <label>التاريخ
            <input type="date" id="saleDate" />
          </label>
          <label>الفرع
            <select id="saleBranch"></select>
          </label>
          <label>الصنف
            <select id="saleItem"></select>
          </label>
          <label>الكمية
            <input type="number" id="saleQty" min="1" step="1" value="1" />
          </label>
        </div>
        <button class="primary" id="btnAddSale">+ إضافة حركة بيع</button>
        <button class="good" id="btnSaveSales">💾 حفظ المبيعات</button>
        <button id="btnExportSales">⬇️ تصدير المبيعات CSV</button>
        <span class="pill">إجمالي السطور: <span id="salesRows">0</span></span>
        <div class="search-box">
          <input type="text" id="searchSales" placeholder="بحث في المبيعات..." />
        </div>
      </div>
      <div class="scroll-x">
        <table id="tblSales"></table>
      </div>
    </section>

    <section id="monthly" class="card" style="display:none">
      <div class="toolbar">
        <label>شهر التقرير
          <input type="month" id="repMonth" />
        </label>
        <label>الفرع
          <select id="repBranch"><option value="">جميع الفروع</option></select>
        </label>
        <button class="primary" id="btnBuildMonthly">حساب التقرير</button>
        <button id="btnExportMonthly">⬇️ تصدير ملخص CSV</button>
      </div>
      <div class="kpi" id="kpi"></div>
      <div class="scroll-x">
        <table id="tblMonthly"></table>
      </div>
      <div class="scroll-x">
        <canvas id="monthlyChart"></canvas>
      </div>
      <p class="note">الاستهلاك النظري = مجموع (كمية بيع الصنف × وصفته لكل مكوّن) لكل يوم.</p>
    </section>

    <section id="inventory" class="card" style="display:none">
      <div class="toolbar">
        <label>الفرع
          <select id="invBranch" onchange="drawInventory()"></select>
        </label>
        <button class="primary" onclick="showAddInvMovementModal()">+ إضافة حركة جرد</button>
        <button class="good" id="btnSaveInv">💾 حفظ الجرد</button>
        <button id="btnCalcVariance">حساب الانحراف</button>
        <button id="btnExportInv">⬇️ تصدير الجرد CSV</button>
        <div class="search-box">
          <input type="text" id="searchMovements" placeholder="بحث في حركات الجرد..." />
        </div>
      </div>
      <div class="scroll-x">
        <table id="tblInventory"></table>
      </div>
      <div class="scroll-x" style="margin-top:12px">
        <table id="tblMovements"></table>
      </div>
      <div class="scroll-x" style="margin-top:12px">
        <canvas id="inventoryChart"></canvas>
      </div>
      <div class="scroll-x" style="margin-top:12px">
        <table id="tblVariance"></table>
      </div>
      <p class="note">الاستهلاك الفعلي = رصيد أول + مشتريات + تحويلات داخلة − تحويلات خارجة − جرد آخر − هالك.</p>
    </section>

    <section id="settings" class="card" style="display:none">
      <div class="toolbar">
        <input type="file" id="fileImport" accept="application/json" />
        <button id="btnImport">📥 استيراد JSON</button>
        <button class="warn" id="btnReset">🗑️ مسح كل البيانات</button>
      </div>
      <p class="muted">صيغة JSON تشمل: branches, ingredients, items, sales, inventory, inventoryMovements.</p>
      <div class="chips" id="ingChips"></div>
    </section>

    <footer class="wrap">
      <span>💡 نصيحة: وحِّد وحدات القياس (قطعة/جرام/لتر) داخل الحسابات.</span>
    </footer>
  </main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ========= Data Model =========
const DB_KEY = 'crispy_chicken_db_v2';
let state = {
  branches: ['Satwa', 'Albarsha', 'Hamdan', 'Almuroor Road', 'Alkhalidiyah', 'Alshabiya 11'],
  ingredients: ['CHIX', 'STRIP', 'BEEFBURGER', 'CHIX BURGER', 'ZINGER', 'FRIES', 'CHEES', 'GARLICSUACE', 'SMALL CLOWSLOW', 'BIG CLOWSLOW', 'DYNAMTESAUCE', 'PEPSI LITER', 'BUN 4 INCH'],
  items: [
    {name: '12 PCS PACKET MIX', family: 'Combo Meal Mix', group: 'Food', recipe: {CHIX: 12, GARLICSUACE: 3, 'SMALL CLOWSLOW': 3, 'BUN 4 INCH': 6}},
    {name: '16 PCS PACKET MIX', family: 'Combo Meal Mix', group: 'Food', recipe: {CHIX: 16, FRIES: 5, GARLICSUACE: 4, 'BUN 4 INCH': 8}}
  ],
  sales: [
    {date: '2025-03-01', branch: 'Satwa', item: '12 PCS PACKET MIX', qty: 1},
    {date: '2025-03-29', branch: 'Satwa', item: '12 PCS PACKET MIX', qty: 111}
  ],
  inventory: {},
  inventoryMovements: []
};

// ========= Persistence =========
function load() {
  const raw = localStorage.getItem(DB_KEY);
  if (raw) {
    try { state = JSON.parse(raw); } catch (e) { console.warn('Failed to parse saved data'); }
  }
}
function save() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }

// ========= Helpers =========
const qs = s => document.querySelector(s);
const ce = (tag, props = {}) => Object.assign(document.createElement(tag), props);
function fmt(n) { return Number(n || 0).toLocaleString('ar-EG'); }
function unique(arr) { return [...new Set(arr)]; }

// ========= Modal Helper =========
function showModal(content, onConfirm) {
  const overlay = ce('div', {className: 'modal-overlay'});
  const modal = ce('div', {className: 'modal', innerHTML: content});
  modal.appendChild(ce('button', {textContent: 'إلغاء', style: 'margin-top:10px;background:#ccc;', onclick: () => { overlay.remove(); modal.remove(); }}));
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
}

// ========= Branches UI =========
function drawBranches() {
  const list = qs('#branchList');
  list.innerHTML = '';
  state.branches.forEach(branch => {
    const li = ce('li', {textContent: `${branch} - Crispy Chicken`, style: 'padding:10px;margin:5px;background:#f9f9f9;border-radius:8px;color:#222;'});
    const delBtn = ce('button', {textContent: 'حذف', style: 'margin-right:10px;background:var(--danger);'});
    delBtn.onclick = () => {
      showModal(`
        <h3>تأكيد حذف الفرع</h3>
        <p>هل أنت متأكد من حذف فرع ${branch}؟</p>
        <button onclick="deleteBranch('${branch}')" style="background:var(--danger);margin-right:10px;">حذف</button>
      `, null);
    };
    li.prepend(delBtn);
    list.appendChild(li);
  });
}

window.deleteBranch = function(branch) {
  state.branches = state.branches.filter(b => b !== branch);
  state.sales = state.sales.filter(s => s.branch !== branch);
  delete state.inventory[branch];
  drawBranches();
  fillSaleBranches();
  fillReportBranches();
  fillInvBranches();
  save();
  qs('.modal').remove();
  qs('.modal-overlay').remove();
};

function showAddBranchModal() {
  showModal(`
    <h3>إضافة فرع جديد</h3>
    <input type="text" id="newBranchInput" placeholder="اسم الفرع (بالإنجليزية)" style="width:100%;margin:10px 0;">
    <button onclick="submitBranch()" style="background:var(--primary);margin-right:10px;">إضافة</button>
  `, null);
}

window.submitBranch = function() {
  const input = qs('#newBranchInput');
  const newBranch = input.value.trim();
  if (newBranch && !state.branches.includes(newBranch) && newBranch.match(/^[a-zA-Z0-9_ ]+$/)) {
    state.branches.push(newBranch);
    drawBranches();
    fillSaleBranches();
    fillReportBranches();
    fillInvBranches();
    save();
    qs('.modal').remove();
    qs('.modal-overlay').remove();
  } else {
    alert('اسم الفرع غير صالح أو موجود مسبقًا!');
  }
};

// ========= Tabs =========
[...document.querySelectorAll('.tab')].forEach(t => t.addEventListener('click', () => {
  document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
  qs('#' + t.dataset.tab).style.display = 'block';
}));

// ========= Recipes UI =========
function drawRecipes() {
  qs('#countItems').textContent = state.items.length;
  qs('#countIngs').textContent = state.ingredients.length;
  const tbl = qs('#tblRecipes');
  tbl.innerHTML = '';
  const thead = ce('thead');
  const hr = ce('tr');
  ['#', 'اسم الصنف', 'المجموعة', 'الفئة', '—'].concat(state.ingredients).forEach((h, i) => {
    const th = ce('th', {textContent: h});
    if (i >= 5) th.title = 'كمية لكل وحدة بيع';
    hr.appendChild(th);
  });
  thead.appendChild(hr);
  tbl.appendChild(thead);
  const tb = ce('tbody');
  state.items.forEach((it, idx) => {
    const tr = ce('tr');
    tr.appendChild(ce('td', {textContent: idx + 1}));
    const name = ce('input', {value: it.name});
    name.onchange = () => { it.name = name.value; fillSaleItems(); save(); };
    const fam = ce('input', {value: it.family || ''});
    fam.onchange = () => { it.family = fam.value; save(); };
    const grp = ce('input', {value: it.group || ''});
    grp.onchange = () => { it.group = grp.value; save(); };
    const del = ce('button', {textContent: 'حذف', style: 'background:var(--danger);'});
    del.onclick = () => { state.items.splice(idx, 1); drawRecipes(); fillSaleItems(); save(); };
    tr.appendChild(ce('td').appendChild(name));
    tr.appendChild(ce('td').appendChild(fam));
    tr.appendChild(ce('td').appendChild(grp));
    tr.appendChild(ce('td').appendChild(del));
    if (!it.recipe) it.recipe = {};
    state.ingredients.forEach(ing => {
      const v = it.recipe[ing] || 0;
      const inp = ce('input', {type: 'number', step: '0.001', value: v});
      inp.onchange = () => { it.recipe[ing] = Number(inp.value) || 0; save(); };
      tr.appendChild(ce('td').appendChild(inp));
    });
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
  drawChips();
}

qs('#btnAddItem').onclick = () => {
  state.items.push({name: 'صنف جديد', family: '', group: '', recipe: {}});
  drawRecipes();
  fillSaleItems();
  save();
};
qs('#btnAddIng').onclick = () => {
  showModal(`
    <h3>إضافة مكوّن جديد</h3>
    <input type="text" id="newIngInput" placeholder="اسم المكوّن (لاتيني)" style="width:100%;margin:10px 0;">
    <button onclick="submitIng()" style="background:var(--primary);margin-right:10px;">إضافة</button>
  `, null);
};
window.submitIng = function() {
  const name = qs('#newIngInput').value.trim();
  if (name && !state.ingredients.includes(name) && name.match(/^[a-zA-Z0-9_]+$/)) {
    state.ingredients.push(name);
    drawRecipes();
    fillSaleItems();
    drawInventory();
    save();
    qs('.modal').remove();
    qs('.modal-overlay').remove();
  } else {
    alert('اسم المكوّن غير صالح أو موجود مسبقًا!');
  }
};
qs('#btnSave').onclick = save;
qs('#btnExport').onclick = () => {
  const url = URL.createObjectURL(new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'}));
  ce('a', {href: url, download: 'crispy_chicken_data.json'}).click();
  URL.revokeObjectURL(url);
};

function drawChips() {
  const box = qs('#ingChips');
  box.innerHTML = '';
  state.ingredients.forEach(ing => box.appendChild(ce('div', {className: 'chip', textContent: ing})));
}

// ========= Sales UI =========
function fillSaleItems() {
  const sel = qs('#saleItem');
  sel.innerHTML = '';
  state.items.forEach(it => sel.appendChild(ce('option', {value: it.name, textContent: it.name})));
}

function fillSaleBranches() {
  const sel = qs('#saleBranch');
  sel.innerHTML = '';
  state.branches.forEach(b => sel.appendChild(ce('option', {value: b, textContent: b})));
}

function drawSales(filter = '') {
  const filteredSales = state.sales.filter(s => 
    s.item.toLowerCase().includes(filter.toLowerCase()) || 
    s.date.includes(filter) || 
    s.branch.toLowerCase().includes(filter.toLowerCase())
  );
  qs('#salesRows').textContent = filteredSales.length;
  const tbl = qs('#tblSales');
  tbl.innerHTML = '';
  const thead = ce('thead');
  thead.innerHTML = '<tr><th>#</th><th>التاريخ</th><th>الفرع</th><th>الصنف</th><th>الكمية</th><th>—</th></tr>';
  tbl.appendChild(thead);
  const tb = ce('tbody');
  filteredSales.forEach((s, i) => {
    const tr = ce('tr');
    tr.appendChild(ce('td', {textContent: i + 1}));
    const d = ce('input', {type: 'date', value: s.date});
    d.onchange = () => { s.date = d.value; save(); };
    const branch = ce('select');
    state.branches.forEach(b => branch.appendChild(ce('option', {value: b, textContent: b, selected: b === s.branch})));
    branch.onchange = () => { s.branch = branch.value; save(); };
    const itm = ce('select');
    state.items.forEach(it => itm.appendChild(ce('option', {value: it.name, textContent: it.name, selected: it.name === s.item})));
    itm.onchange = () => { s.item = itm.value; save(); };
    const q = ce('input', {type: 'number', step: '1', min: '0', value: s.qty});
    q.onchange = () => { s.qty = Number(q.value) || 0; save(); };
    const del = ce('button', {textContent: 'حذف', style: 'background:var(--danger);'});
    del.onclick = () => { state.sales.splice(state.sales.indexOf(s), 1); drawSales(filter); save(); };
    tr.appendChild(ce('td').appendChild(d));
    tr.appendChild(ce('td').appendChild(branch));
    tr.appendChild(ce('td').appendChild(itm));
    tr.appendChild(ce('td').appendChild(q));
    tr.appendChild(ce('td').appendChild(del));
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
}

qs('#btnAddSale').onclick = () => {
  const d = qs('#saleDate').value || new Date().toISOString().slice(0, 10);
  const branch = qs('#saleBranch').value || state.branches[0] || '';
  const it = qs('#saleItem').value || (state.items[0]?.name || '');
  const q = Number(qs('#saleQty').value) || 1;
  if (q <= 0) return alert('الكمية يجب أن تكون أكبر من 0');
  state.sales.push({date: d, branch, item: it, qty: q});
  drawSales();
  save();
};
qs('#btnSaveSales').onclick = save;
qs('#btnExportSales').onclick = () => {
  const rows = [['Date', 'Branch', 'Item', 'Qty']].concat(state.sales.map(s => [s.date, s.branch, s.item, s.qty]));
  const csv = '\uFEFF' + rows.map(r => r.join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
  ce('a', {href: url, download: 'sales.csv'}).click();
  URL.revokeObjectURL(url);
};
qs('#searchSales').oninput = () => drawSales(qs('#searchSales').value);

// ========= Calculations =========
function mapRecipe(itemName) {
  const it = state.items.find(x => x.name === itemName);
  return it?.recipe || {};
}

function usageByDate(date, branch = '') {
  const obj = {};
  state.sales.filter(s => s.date === date && (!branch || s.branch === branch)).forEach(s => {
    const rec = mapRecipe(s.item);
    Object.entries(rec).forEach(([ing, qty]) => {
      obj[ing] = (obj[ing] || 0) + (s.qty * Number(qty || 0));
    });
  });
  return obj;
}

function usageByMonth(ym, branch = '') {
  const days = daysInMonth(ym);
  const result = {};
  days.forEach(d => { result[d] = usageByDate(d, branch); });
  return result;
}

function daysInMonth(ym) {
  const [y, m] = ym.split('-').map(Number);
  const last = new Date(y, m, 0).getDate();
  const arr = [];
  for (let d = 1; d <= last; d++) {
    arr.push(`${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`);
  }
  return arr;
}

// ========= Monthly UI =========
function fillReportBranches() {
  const sel = qs('#repBranch');
  sel.innerHTML = '<option value="">جميع الفروع</option>';
  state.branches.forEach(b => sel.appendChild(ce('option', {value: b, textContent: b})));
}

let monthlyChart = null;
qs('#btnBuildMonthly').onclick = buildMonthly;
function buildMonthly() {
  const ym = qs('#repMonth').value || new Date().toISOString().slice(0, 7);
  const branch = qs('#repBranch').value;
  const days = daysInMonth(ym);
  const use = usageByMonth(ym, branch);
  const tbl = qs('#tblMonthly');
  tbl.innerHTML = '';
  const thead = ce('thead');
  const hr = ce('tr');
  hr.appendChild(ce('th', {textContent: 'التاريخ'}));
  state.ingredients.forEach(ing => hr.appendChild(ce('th', {textContent: ing})));
  thead.appendChild(hr);
  tbl.appendChild(thead);
  const tb = ce('tbody');
  let totals = {};
  days.forEach(d => {
    const tr = ce('tr');
    tr.appendChild(ce('td', {textContent: d}));
    state.ingredients.forEach(ing => {
      const v = (use[d]?.[ing]) || 0;
      totals[ing] = (totals[ing] || 0) + v;
      tr.appendChild(ce('td', {textContent: fmt(v)}));
    });
    tb.appendChild(tr);
  });
  const trT = ce('tr', {style: 'background:#0e1a3a'});
  trT.appendChild(ce('td', {innerHTML: '<b>TOTAL Recipe</b>'}));
  state.ingredients.forEach(ing => trT.appendChild(ce('td', {innerHTML: `<b>${fmt(totals[ing] || 0)}</b>`})));
  tb.appendChild(trT);
  tbl.appendChild(tb);

  const k = qs('#kpi');
  k.innerHTML = '';
  const sumSales = state.sales.filter(s => s.date.startsWith(ym) && (!branch || s.branch === branch)).reduce((a, b) => a + b.qty, 0);
  k.appendChild(kpi('إجمالي سطور المبيعات', sumSales));
  k.appendChild(kpi('عدد المكونات', state.ingredients.length));
  k.appendChild(kpi('عدد الأصناف', state.items.length));
  k.appendChild(kpi('أيام الشهر', days.length));

  state.__lastMonthlyTotals = totals;
  save();

  if (monthlyChart) monthlyChart.destroy();
  monthlyChart = new Chart(qs('#monthlyChart'), {
    type: 'bar',
    data: {
      labels: state.ingredients,
      datasets: [{
        label: `الاستهلاك الشهري (${ym}${branch ? ' - ' + branch : ''})`,
        data: state.ingredients.map(ing => totals[ing] || 0),
        backgroundColor: '#4dd0e1',
        borderColor: '#1f2b50',
        borderWidth: 1
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } }
    }
  });
}

function kpi(title, val) {
  const d = ce('div', {className: 'box'});
  d.innerHTML = `<h3>${title}</h3><b>${fmt(val)}</b>`;
  return d;
}

qs('#btnExportMonthly').onclick = () => {
  const ym = qs('#repMonth').value || new Date().toISOString().slice(0, 7);
  const branch = qs('#repBranch').value;
  const totals = state.__lastMonthlyTotals || {};
  const rows = [['Ingredient', `TotalRecipe(${ym}${branch ? '-' + branch : ''})`]];
  state.ingredients.forEach(ing => rows.push([ing, (totals[ing] || 0)]));
  const csv = '\uFEFF' + rows.map(r => r.join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
  ce('a', {href: url, download: `monthly_totals_${ym}${branch ? '_' + branch : ''}.csv`}).click();
  URL.revokeObjectURL(url);
};

// ========= Inventory & Variance =========
function fillInvBranches() {
  const sel = qs('#invBranch');
  sel.innerHTML = '';
  state.branches.forEach(b => sel.appendChild(ce('option', {value: b, textContent: b})));
}

function getLastMonthEnd(branch, ingredient, currentYM) {
  const [y, m] = currentYM.split('-').map(Number);
  const lastMonth = new Date(y, m - 1, 0).toISOString().slice(0, 7);
  const lastInv = state.inventory[branch]?.find(i => i.ingredient === ingredient && i.lastUpdated.startsWith(lastMonth));
  return lastInv?.end || 0;
}

function updateInventoryEnd(branch, ingredient) {
  const inv = state.inventory[branch]?.find(i => i.ingredient === ingredient) || {begin: 0, purchases: 0, tin: 0, tout: 0, waste: 0, end: 0, lastUpdated: new Date().toISOString().slice(0, 10)};
  inv.end = (inv.begin || 0) + (inv.purchases || 0) + (inv.tin || 0) - (inv.tout || 0) - (inv.waste || 0);
  inv.lastUpdated = new Date().toISOString().slice(0, 10);
  if (!state.inventory[branch]) state.inventory[branch] = [];
  if (!state.inventory[branch].find(i => i.ingredient === ingredient)) {
    state.inventory[branch].push(inv);
  }
}

function ensureInv() {
  const currentYM = new Date().toISOString().slice(0, 7);
  state.branches.forEach(branch => {
    if (!state.inventory[branch]) state.inventory[branch] = [];
    state.ingredients.forEach(ing => {
      if (!state.inventory[branch].find(i => i.ingredient === ing)) {
        state.inventory[branch].push({
          ingredient: ing,
          begin: getLastMonthEnd(branch, ing, currentYM),
          purchases: 0,
          tin: 0,
          tout: 0,
          waste: 0,
          end: 0,
          lastUpdated: new Date().toISOString().slice(0, 10)
        });
      }
    });
  });
}

let inventoryChart = null;
function drawInventory() {
  ensureInv();
  const branch = qs('#invBranch').value || state.branches[0];
  const tbl = qs('#tblInventory');
  tbl.innerHTML = '';
  const thead = ce('thead');
  thead.innerHTML = '<tr><th>المكوّن</th><th>رصيد أول</th><th>مشتريات</th><th>تحويلات داخلة</th><th>تحويلات خارجة</th><th>هالك</th><th>رصيد آخر</th><th>حالة</th></tr>';
  tbl.appendChild(thead);
  const tb = ce('tbody');
  state.inventory[branch]?.forEach(inv => {
    const tr = ce('tr');
    tr.appendChild(ce('td', {textContent: inv.ingredient}));
    ['begin', 'purchases', 'tin', 'tout', 'waste'].forEach(key => {
      const inp = ce('input', {type: 'number', step: '0.001', value: inv[key] || 0});
      inp.onchange = () => {
        inv[key] = Number(inp.value) || 0;
        updateInventoryEnd(branch, inv.ingredient);
        drawInventory();
        save();
      };
      tr.appendChild(ce('td').appendChild(inp));
    });
    const endTd = ce('td', {textContent: fmt(inv.end)});
    tr.appendChild(endTd);
    const statusTd = ce('td', {textContent: inv.end < 10 ? '⚠️ منخفض' : '✅ طبيعي', style: inv.end < 10 ? 'color:var(--danger)' : 'color:var(--ok)'});
    tr.appendChild(statusTd);
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);

  drawInventoryMovements();

  if (inventoryChart) inventoryChart.destroy();
  inventoryChart = new Chart(qs('#inventoryChart'), {
    type: 'bar',
    data: {
      labels: state.ingredients,
      datasets: [{
        label: `الرصيد الختامي (${branch})`,
        data: state.inventory[branch]?.map(i => i.end) || [],
        backgroundColor: '#4dd0e1',
        borderColor: '#1f2b50',
        borderWidth: 1
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } }
    }
  });
}

function drawInventoryMovements(filter = '') {
  const branch = qs('#invBranch').value || state.branches[0];
  const filteredMovements = state.inventoryMovements.filter(m => 
    (!branch || m.branch === branch) && 
    (m.ingredient.toLowerCase().includes(filter.toLowerCase()) || m.date.includes(filter) || m.type.includes(filter))
  );
  const tbl = qs('#tblMovements');
  tbl.innerHTML = '';
  const thead = ce('thead');
  thead.innerHTML = '<tr><th>#</th><th>التاريخ</th><th>الفرع</th><th>المكوّن</th><th>نوع الحركة</th><th>الكمية</th><th>—</th></tr>';
  tbl.appendChild(thead);
  const tb = ce('tbody');
  filteredMovements.forEach((m, i) => {
    const tr = ce('tr');
    tr.appendChild(ce('td', {textContent: i + 1}));
    const d = ce('input', {type: 'date', value: m.date});
    d.onchange = () => { m.date = d.value; save(); drawInventoryMovements(filter); };
    const branchSel = ce('select');
    state.branches.forEach(b => branchSel.appendChild(ce('option', {value: b, textContent: b, selected: b === m.branch})));
    branchSel.onchange = () => { m.branch = branchSel.value; save(); drawInventoryMovements(filter); };
    const ingSel = ce('select');
    state.ingredients.forEach(ing => ingSel.appendChild(ce('option', {value: ing, textContent: ing, selected: ing === m.ingredient})));
    ingSel.onchange = () => { m.ingredient = ingSel.value; save(); drawInventoryMovements(filter); };
    const typeSel = ce('select');
    ['purchases', 'tin', 'tout', 'waste'].forEach(t => typeSel.appendChild(ce('option', {value: t, textContent: t, selected: t === m.type})));
    typeSel.onchange = () => { m.type = typeSel.value; save(); drawInventoryMovements(filter); };
    const qty = ce('input', {type: 'number', step: '0.001', min: '0', value: m.qty});
    qty.onchange = () => { m.qty = Number(qty.value) || 0; updateInventoryEnd(m.branch, m.ingredient); save(); drawInventory(); drawInventoryMovements(filter); };
    const del = ce('button', {textContent: 'حذف', style: 'background:var(--danger);'});
    del.onclick = () => { state.inventoryMovements.splice(state.inventoryMovements.indexOf(m), 1); updateInventoryEnd(m.branch, m.ingredient); save(); drawInventory(); drawInventoryMovements(filter); };
    tr.appendChild(ce('td').appendChild(d));
    tr.appendChild(ce('td').appendChild(branchSel));
    tr.appendChild(ce('td').appendChild(ingSel));
    tr.appendChild(ce('td').appendChild(typeSel));
    tr.appendChild(ce('td').appendChild(qty));
    tr.appendChild(ce('td').appendChild(del));
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
}

qs('#searchMovements').oninput = () => drawInventoryMovements(qs('#searchMovements').value);

function showAddInvMovementModal() {
  showModal(`
    <h3>إضافة حركة جرد</h3>
    <label>التاريخ
      <input type="date" id="movDate" value="${new Date().toISOString().slice(0, 10)}" />
    </label>
    <label>الفرع
      <select id="movBranch">${state.branches.map(b => `<option value="${b}">${b}</option>`).join('')}</select>
    </label>
    <label>المكوّن
      <select id="movIng">${state.ingredients.map(ing => `<option value="${ing}">${ing}</option>`).join('')}</select>
    </label>
    <label>نوع الحركة
      <select id="movType">
        <option value="purchases">مشتريات</option>
        <option value="tin">تحويلات داخلة</option>
        <option value="tout">تحويلات خارجة</option>
        <option value="waste">هالك</option>
      </select>
    </label>
    <label>الكمية
      <input type="number" id="movQty" min="0" step="0.001" value="0" />
    </label>
    <button onclick="submitInvMovement()" style="background:var(--primary);margin-right:10px;">إضافة</button>
  `, null);
}

window.submitInvMovement = function() {
  const date = qs('#movDate').value;
  const branch = qs('#movBranch').value;
  const ingredient = qs('#movIng').value;
  const type = qs('#movType').value;
  const qty = Number(qs('#movQty').value) || 0;
  if (qty <= 0) return alert('الكمية يجب أن تكون أكبر من 0');
  if (!state.inventoryMovements) state.inventoryMovements = [];
  state.inventoryMovements.push({date, branch, ingredient, type, qty});
  updateInventoryEnd(branch, ingredient);
  drawInventory();
  drawInventoryMovements();
  save();
  qs('.modal').remove();
  qs('.modal-overlay').remove();
};

qs('#btnSaveInv').onclick = save;
qs('#btnExportInv').onclick = () => {
  const branch = qs('#invBranch').value || state.branches[0];
  const rows = [['Ingredient', 'Begin', 'Purchases', 'Tin', 'Tout', 'Waste', 'End', 'LastUpdated']];
  state.inventory[branch]?.forEach(inv => rows.push([
    inv.ingredient, inv.begin, inv.purchases, inv.tin, inv.tout, inv.waste, inv.end, inv.lastUpdated
  ]));
  const csv = '\uFEFF' + rows.map(r => r.join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
  ce('a', {href: url, download: `inventory_${branch}.csv`}).click();
  URL.revokeObjectURL(url);
};

qs('#btnCalcVariance').onclick = () => {
  const branch = qs('#invBranch').value;
  const totals = state.__lastMonthlyTotals || {};
  const tbl = qs('#tblVariance');
  tbl.innerHTML = '';
  const thead = ce('thead');
  thead.innerHTML = '<tr><th>المكوّن</th><th>Total Recipe</th><th>Actual</th><th>Variance</th></tr>';
  tbl.appendChild(thead);
  const tb = ce('tbody');
  state.inventory[branch]?.forEach(inv => {
    const actual = (inv.begin || 0) + (inv.purchases || 0) + (inv.tin || 0) - (inv.tout || 0) - (inv.waste || 0);
    const recipe = totals[inv.ingredient] || 0;
    const varc = actual - recipe;
    const tr = ce('tr');
    tr.appendChild(ce('td', {textContent: inv.ingredient}));
    tr.appendChild(ce('td', {textContent: fmt(recipe)}));
    tr.appendChild(ce('td', {textContent: fmt(actual)}));
    const tdv = ce('td', {textContent: fmt(varc)});
    tdv.style.color = Math.abs(varc / (recipe || 1)) > 0.1 ? 'var(--danger)' : 'var(--ok)';
    tr.appendChild(tdv);
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);
};

// ========= Import / Reset =========
qs('#btnImport').onclick = () => {
  const f = qs('#fileImport').files[0];
  if (!f) return alert('اختر ملف JSON');
  const r = new FileReader();
  r.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.branches && data.ingredients && data.items && data.sales && data.inventory && data.inventoryMovements) {
        state = data;
        save();
        init();
        alert('تم الاستيراد بنجاح');
      } else {
        alert('ملف JSON غير صالح: يجب أن يحتوي على branches, ingredients, items, sales, inventory, inventoryMovements');
      }
    } catch (err) {
      alert('خطأ في استيراد الملف');
    }
  };
  r.readAsText(f);
};
qs('#btnReset').onclick = () => {
  showModal(`
    <h3>تأكيد حذف البيانات</h3>
    <p>هل أنت متأكد من مسح كل البيانات؟ هذا لا يمكن التراجع عنه.</p>
    <button onclick="resetData()" style="background:var(--danger);margin-right:10px;">حذف</button>
  `, null);
};
window.resetData = () => {
  localStorage.removeItem(DB_KEY);
  location.reload();
};

// ========= Boot =========
function init() {
  load();
  drawBranches();
  drawRecipes();
  fillSaleItems();
  fillSaleBranches();
  fillReportBranches();
  fillInvBranches();
  drawSales();
  qs('#repMonth').value = new Date().toISOString().slice(0, 7);
  buildMonthly();
  drawInventory();
}
init();
</script>
</body>
</html>
